stages:
  - prepare
  - sast_scan
  - test
  - build
  - security
  - dast_scan
  - deploy
  - update-deployment-manifest
  - slack_notify
  - clean_up

image: node:23-bookworm-slim

cache:
  paths:
    - node_modules/

# ---- PREPARE ----
install_dependencies:
  stage: prepare
  tags:
    - linux-homelab-general-vm
  script:
    - npm ci --ignore-scripts
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ---- ESLINT ----
eslint:
  stage: sast_scan
  script:
    - npm run lint

# ---- GITLEAKS SCAN ----
gitleaks_scan:
  stage: sast_scan
  tags:
    - linux-homelab-general-vm
  image: 
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - gitleaks detect --source . --exit-code 1 --no-git --redact --report-path gitleaks-report.json
  artifacts:
    paths:
      - gitleaks-report.json
    when: always
  allow_failure: false

# ---- DEPENDENCY AUDIT ----
npm_audit:
    stage: sast_scan
    script:
        - npm audit --audit-level=moderate
    allow_failure: false

# ---- SONARCLOUD ----
# This job runs the SonarCloud analysis. It requires the `SONAR_TOKEN` variable
sonarcloud-check:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  stage: sast_scan
  script:
    - echo 'sonarqube'
    - sonar-scanner
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'

# ---- TEST ----
unit_test:
  stage: test
  script:
    - npm run test
  needs: [install_dependencies]

playwright_test:
  stage: test
  image: mcr.microsoft.com/playwright:v1.54.0-noble
  before_script:
    - npx playwright install chrome
  script:
    - npm run playwright --reporter=html --output=playwright-report
  needs: [install_dependencies]
  artifacts:
    when: always
    paths:
      - playwright-report/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'

# ---- BUILD IMAGE ----
build:
    stage: build
    image: docker:latest
    services:
        - docker:dind
    variables:
      DOCKER_NAME: 'cheulong/movies-finder-frontend'
      DOCKER_IMAGE: $CI_REGISTRY_IMAGE
      DOCKER_TAG: $CI_COMMIT_SHORT_SHA
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
    script:
      - echo $CI_REGISTRY_PASSWORD | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
      - docker build -f Dockerfile.prod -t $DOCKER_IMAGE:$DOCKER_TAG .
      - docker push $DOCKER_IMAGE:$DOCKER_TAG
    rules:
      - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ---- TRIVY SCAN ----
# This job runs the Trivy security scanner against the Docker image and filesystem.
trivy_scan:
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  stage: security
  variables:
      DOCKER_NAME: 'cheulong/movies-finder-frontend'
      DOCKER_IMAGE: $CI_REGISTRY_IMAGE
      DOCKER_TAG: $CI_COMMIT_SHORT_SHA
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL --output trivy-report.json $DOCKER_IMAGE:$DOCKER_TAG
  allow_failure: false
  needs: [docker_build]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  artifacts:
    paths:
      - trivy-report.json
    when: always

# ---- SYFT SBOM ----
# This job generates a Software Bill of Materials (SBOM) using Syft.
syft_sbom:
  image:
    name: docker:latest
  stage: security
  variables:
    DOCKER_NAME: 'cheulong/movies-finder-frontend'
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE
    DOCKER_TAG: $CI_COMMIT_SHORT_SHA
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  services:
        - docker:dind
  needs: [docker_build]
  before_script:
    # Login to GitLab Container Registry to pull the image
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - docker pull $DOCKER_IMAGE:$DOCKER_TAG
    - apk add --no-cache curl bash
    - curl -sSfL https://get.anchore.io/syft | sh -s -- -b /usr/local/bin
  script:
    - syft --version
    - syft $DOCKER_IMAGE:$DOCKER_TAG -o spdx-json > sbom.spdx.json
  artifacts:
    paths:
      - sbom.spdx.json
  when: always
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "staging"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'

# ---- GRYPE SCAN ----
# This job runs the Grype vulnerability scanner against the SBOM generated by Syft.
grype_scan:
  image:
    name: alpine:latest
  stage: security
  needs: [syft_sbom]
  before_script:
    - apk add --no-cache curl bash
    - curl -sSfL https://get.anchore.io/grype | sh -s -- -b /usr/local/bin
  script:
    - grype sbom:sbom.spdx.json --fail-on high
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "staging"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'

# ---- RUN APP ----
# This job runs the application using Docker Compose.
run_app:
  stage: dast_scan
  image:
    name: docker:latest
  needs:
    - job: docker_build
  variables:
    DOCKER_NAME: 'cheulong/movies-finder-frontend'
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE
    DOCKER_TAG: $CI_COMMIT_SHORT_SHA
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  services:
    - name: docker:dind
      alias: docker

  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - docker pull $DOCKER_IMAGE:$DOCKER_TAG
  script:
    - docker run --name app --rm -d -p 80:80 $DOCKER_IMAGE:$DOCKER_TAG
    - sleep 15  # wait for app to start
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ---- OWASP ZAP ----
# This job runs the OWASP ZAP security scanner against the application.
owap_zap:
    stage: dast_scan
    image: zaproxy/zap-stable
    allow_failure: true
    services:
    - name: $DOCKER_IMAGE:e4ac7b2b
      alias: app
    variables:
      DOCKER_NAME: 'cheulong/movies-finder-frontend'
      DOCKER_IMAGE: $CI_REGISTRY_IMAGE
    before_script:
    - mkdir -p /zap/wrk
    script:
        - echo 'owap zap'
        - zap-baseline.py -t http://app:80 -g gen.conf -r zap-report.html || true
        - ls
        - cp /zap/wrk/zap-report.html .
        # full scan: zap-full-scan.py
        # api scan: zap-api-scan.py
    needs:
      - job: run_app
    artifacts:
        expire_in: "30 days"
        when: always
        paths:
          - zap-report.html
    rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'


# ---- PUSH IMAGE ----
push_image:
    stage: deploy
    image: docker:latest
    services:
        - docker:dind
    variables:
      DOCKER_NAME: 'cheulong/movies-finder-frontend'
      DOCKER_IMAGE: $CI_REGISTRY_IMAGE
      DOCKER_TAG: $CI_COMMIT_SHORT_SHA
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
    script:
        - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
        - docker pull $DOCKER_IMAGE:$DOCKER_TAG
        - docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_NAME:latest
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push $DOCKER_NAME:latest
    rules:
      - if: '$CI_COMMIT_BRANCH == "dev"'


# ---- UPDATE MANIFEST REPO ----
deploy_dev:
  image: alpine:latest
  stage: deploy
#   needs:
#     - update_manifest_repo

  before_script:
    - apk add --no-cache git bash
  script:
    - git config --global user.email "ci@example.com"
    - git config --global user.name "GitLab CI"
    - git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/cheulong-devops/movies-finder/movies-finder-deployment.git
    - cd movies-finder-deployment/web-app
    - 'sed -i "s|tag:.*|tag: $CI_COMMIT_SHORT_SHA|" values.dev.yaml'
    - echo "Checking for changes..."
    - |
        if git diff --quiet; then
          echo "No changes to commit."
        else
          git add .
          git commit -m "Update development deployment image tag to $CI_COMMIT_SHORT_SHA"
          git push https://oauth2:$GITLAB_PAT@gitlab.com/cheulong-devops/movies-finder/movies-finder-deployment.git HEAD:main
        fi
  rules:
  - if: '$CI_COMMIT_BRANCH == "dev"'

deploy_staging:
  image: alpine:latest
  stage: deploy
#   needs:
#     - update_manifest_repo
  variables:
    DEPLOY_ENV: "staging"
  before_script:
    - apk add --no-cache git bash
  script:
    - git config --global user.email "ci@example.com"
    - git config --global user.name "GitLab CI"
    - git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/cheulong-devops/movies-finder/movies-finder-deployment.git
    - cd movies-finder-deployment/web-app
    - "IMAGE_TAG=$(grep 'tag:' values.dev.yaml | head -1 | sed 's/tag: //')"
    - 'sed -i "s|tag:.*|tag: $IMAGE_TAG|" values.staging.yaml'
    - echo "Checking for changes..."
    - |
        if git diff --quiet; then
          echo "No changes to commit."
        else
          git add .
          git commit -m "Update staging deployment image tag to $IMAGE_TAG"
          git push https://oauth2:$GITLAB_PAT@gitlab.com/cheulong-devops/movies-finder/movies-finder-deployment.git HEAD:main
        fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
  when: manual
  


deploy_prod:
  image: alpine:latest
  stage: deploy
#   needs:
#     - update_manifest_repo
  variables:
    DEPLOY_ENV: "production"
  before_script:
    - apk add --no-cache git bash
  script:
    - git config --global user.email "ci@example.com"
    - git config --global user.name "GitLab CI"
    - git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/cheulong-devops/movies-finder/movies-finder-deployment.git
    - cd movies-finder-deployment/web-app
    - "IMAGE_TAG=$(grep 'tag:' values.dev.yaml | head -1 | sed 's/tag: //')"
    - 'sed -i "s|tag:.*|tag: $IMAGE_TAG|" values.staging.yaml'
    - echo "Checking for changes..."
    - |
        if git diff --quiet; then
          echo "No changes to commit."
        else
          git add .
          git commit -m "Update production deployment image tag to $IMAGE_TAG"
          git push https://oauth2:$GITLAB_PAT@gitlab.com/cheulong-devops/movies-finder/movies-finder-deployment.git HEAD:main
        fi
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'



# ---- SLACK NOTIFY ----
slack_notify:
    image:
      name: alpine:latest
    stage: slack_notify
    before_script:
    - apk add --no-cache curl
    script:
      - |
          if [ "$DEPLOY_ENV" = "staging" ]; then
            MESSAGE="ðŸš€ Deployed to *STAGING*
          elif [ "$DEPLOY_ENV" = "production" ]; then
            MESSAGE="ðŸ”¥ Deployed to *PRODUCTION*
          else
            MESSAGE="âœ… Deployment complete â€“ $CI_COMMIT_SHORT_SHA"
          fi

          echo "Sending Slack notification: $MESSAGE"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$MESSAGE\"}" "$SLACK_WEBHOOK"


# --- Clean up ---
clean_up:
  stage: clean_up
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Stop docker container"
    - docker stop app || true
    - echo "Cleaning up temporary files"
    - rm -rf node_modules/
  when: always
  allow_failure: true
